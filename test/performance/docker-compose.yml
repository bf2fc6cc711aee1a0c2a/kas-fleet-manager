version: '3'

services:

  primary:
    image: "quay.io/ppaszki/locust:latest"
    environment:
      - OCM_OFFLINE_TOKEN=${OCM_OFFLINE_TOKEN}
      - ATTACKED_HOST=${PERF_TEST_ROUTE_HOST}
      - LOCUST_FILE=/mnt/locust/locustfile.py
      - LOCUST_MODE=master
      - LOCUST_MASTER_HOST=primary
      - LOCUST_OPTS=--headless -u ${PERF_TEST_USERS} -r ${PERF_TEST_USER_SPAWN_RATE} --run-time ${PERF_TEST_RUN_TIME}
    ports:
      - 8089:8089
    volumes:
      - ./:/mnt/locust
    command: -f /mnt/locust/locustfile.py --master -H http://primary:8089

  secondary:
    image: "quay.io/ppaszki/locust:latest"
    environment:
      - OCM_OFFLINE_TOKEN=${OCM_OFFLINE_TOKEN}
      - ATTACKED_HOST=${PERF_TEST_ROUTE_HOST}
      - LOCUST_FILE=/mnt/locust/locustfile.py
      - LOCUST_MODE=worker
      - LOCUST_MASTER_HOST=primary
    volumes:
      - ./:/mnt/locust
    command: -f /mnt/locust/locustfile.py --worker --master-host primary
